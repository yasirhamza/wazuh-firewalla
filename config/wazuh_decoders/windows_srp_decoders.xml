<!--
  Windows Software Restriction Policy (SRP) Log Decoder
  Log location: C:\ParentalControl\Logs\*.log

  Standard format:
    <process> (PID = <pid>) identified <path> as <decision> using <rule_type>, Guid = {<guid>}

  Enriched format (via -ConvertAndEnrichSaferLog):
    <standard>|<timestamp>|SHA256:<hash>|SHA1:<hash>
-->

<decoder name="windows-srp">
  <prematch>PID = \d+\) identified </prematch>
</decoder>

<!-- Enriched format with timestamp and hashes - MUST be before standard format -->
<!-- Note: Using srp.sha256/sha1 because data.file is already mapped as keyword in ES -->
<decoder name="windows-srp-enriched">
  <parent>windows-srp</parent>
  <prematch offset="after_parent">SHA256:</prematch>
  <regex type="pcre2" offset="after_parent">(.+?) as (\S+) using (.+?), Guid = \{[^}]+\}\|([^|]+)\|SHA256:([^|]*)\|SHA1:(\S*)</regex>
  <order>srp.target_path, srp.decision, srp.rule_type, srp.timestamp, srp.sha256, srp.sha1</order>
</decoder>

<!-- Standard format (non-enriched) -->
<decoder name="windows-srp-fields">
  <parent>windows-srp</parent>
  <regex type="pcre2" offset="after_parent">(.+?) as (\S+) using (.+?), Guid = \{[^}]+\}$</regex>
  <order>srp.target_path, srp.decision, srp.rule_type</order>
</decoder>

<!--
  Baseline Sync Event Decoder
  Log format: BASELINE_SYNC|<timestamp>|entries:<count>|file:<path>
-->
<decoder name="srp-baseline-sync">
  <prematch>^BASELINE_SYNC\|</prematch>
</decoder>

<decoder name="srp-baseline-sync-fields">
  <parent>srp-baseline-sync</parent>
  <regex type="pcre2">^BASELINE_SYNC\|(\S+)\|entries:(\d+)\|file:(.+)$</regex>
  <order>srp.sync_timestamp, srp.entry_count, srp.cdb_file</order>
</decoder>

<!--
  CDB Upload Decoder - captures base64-encoded CDB file from agent
  Log format: CDB_UPLOAD|entries:<count>|data:<base64>
-->
<decoder name="srp-cdb-upload">
  <prematch>^CDB_UPLOAD\|</prematch>
</decoder>

<decoder name="srp-cdb-upload-fields">
  <parent>srp-cdb-upload</parent>
  <regex type="pcre2">^CDB_UPLOAD\|entries:(\d+)\|data:(.+)$</regex>
  <order>srp.entry_count, srp.cdb_data</order>
</decoder>
